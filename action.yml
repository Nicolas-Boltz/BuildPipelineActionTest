name: 'Palladio Build Pipeline'
description: 'Build of Palladio Project'
inputs:
  build-repository:  # id of input
    description: 'Repository to build'
    required: true
    default:  ${{ github.repository }}
  use-display-output:  # id of input
    description: 'If display output is needed for ui tesing'
    required: false
    default: false
  deploy-updatesite:
    description: 'Updatesite for deployment. If empty deployment is skipped'
    required: false
    default: ''
  java-version:
    description: 'Java version for build. Default 11'
    required: false
    default: '11'
  SERVER_SSH_KEY:
    description: 'SSH Key for deployment'
    required: true
    default: ''
  REMOTE_HOST:
    description: 'Remote host ip'
    required: true
    default: ''
  REMOTE_PORT:
    description: 'Remote host port'
    required: true
    default: ''
  REMOTE_USER:
    description: 'Remote host user'
    required: true
    default: ''
  REMOTE_TARGET:
    description: 'Remote host target path'
    required: true
    default: ''
  DEPLOY_TEST:
    description: 'Switch to turn deployment on and off'
    required: true
    default: false

runs:
  using: "composite"
  steps:
      - uses: actions/checkout@v3
        with:
          repository: ${{ inputs.build-repository }}
          submodules: true
      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ inputs.java-version }}
          cache: 'maven'
      - name: Verify with Maven
        shell: bash
        run: |
          if ${{ inputs.use-display-output }}; then
              DISPLAY=:0 mvn clean verify
          else
              mvn clean verify
          fi
      - name: Deploy test
        if: ${{ inputs.DEPLOY_TEST }}
        uses: easingthemes/ssh-deploy@v2
        env:
          SSH_PRIVATE_KEY: ${{ inputs.SERVER_SSH_KEY }}
          ARGS: "-rltgoDzvO"
          SOURCE: ${{ inputs.deploy-updatesite }}
          REMOTE_HOST: ${{ inputs.REMOTE_HOST }}
          REMOTE_PORT: ${{ inputs.REMOTE_PORT }}
          REMOTE_USER: ${{ inputs.REMOTE_USER }}
          TARGET: '${{ inputs.REMOTE_TARGET }}/deploy-test/'
          
